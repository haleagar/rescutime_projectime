<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rescuetime Data Query for Time Reports</title>
    <script src="node_modules/jsonq/jsonQ.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        //$( document ).ready(function() {
        $( function() {
            console.log( "ready!" );
            document.proj = {door3:['door3','rescuetime','projectorpsa'],green:['green','dunn','808705e3-d1e0-48d6-9e92-563ba1af548e']};
            document.probablyproj = {door3:['gmail','phpstorm'],green:['green','dunn']};
            document.proj['wahv'] = $('#keywords-wahv').val().trim().split("\n")
            document.probablyproj['wahv'] =$('#probablykeywords-wahv').val().trim().split("\n")
            document.jsonQobj = {};
            document.strucData = {};
            var day = "2017-01-09";
            var rtAPIkey = 'B639daNB9cIPMCFK3ulFjwliHdu5Eygc2Bw0BW8T';
            var apiURL = "https://www.rescuetime.com/anapi/data";//?callback=?
            $.ajaxSetup({ dataType: "jsonp" });
            $( "#datepicker" ).datepicker();
            $( "button#load-data" ).click( function( event ) {
                event.preventDefault();
                var currentDate = $( "#datepicker" ).datepicker( "getDate" );
                day = $.datepicker.formatDate( "yy-mm-dd", currentDate );
                console.log("day",day);
                $.getJSON( apiURL, {
                    key:rtAPIkey,
                    rs: "minute",
                    rb: day,
                    re: day,
                    pv: 'interval',
                    rk: 'document',
                    format: "json"
                }).done(function( data ) {
                    $("#preview-json").val(data['rows']);
                    //console.log('data notes',data['notes']);
                    console.log('data row_headers',data['row_headers']);
                    //console.log('data rows',data['rows']);
                    $.each( data.rows, function( i, row ) {
                        //$( "<img>" ).attr( "src", item.media.m ).appendTo( "#images" );
                        var time = row[0];
                        var duration = row[1];
                        var app = row[3];
                        var title = row[4];
                        var rowObj = {time:time,duration:duration,app:app,title:title,project:'UNALOCATED'};
                        if (document.strucData[time] == undefined) {
                            document.strucData[time] = {total:0,missing:0,project:{WAHV:0,PGPF:0,GREEN:0,PCH:0,DOOR3:0,PERSONAL:0,UNALOCATED:0},data:[]};
                        }
                        document.strucData[time]['data'].push( rowObj );
                        document.strucData[time]['total'] += duration;
                        document.strucData[time]['missing'] = 300 - document.strucData[time]['total'];
                        if ((app+title).toLowerCase().includes('wahv')){
                            document.strucData[time]['project']['WAHV']  += duration;
                            rowObj['project'] = 'WAHV';
                        }
                        else if ((app+title).toLowerCase().includes('pgpf'))   {
                            document.strucData[time]['project']['PGPF'] += duration;
                            rowObj['project'] = 'PGPF';
                        }
                        else if (document.proj.green.some(function(v) { return (app+title).toLowerCase().indexOf(v) >= 0; }))  {
                            document.strucData[time]['project']['GREEN']  += duration;
                            rowObj['project'] = 'GREEN';
                        }
                        else if ((app+title).toLowerCase().includes('pch'))    {
                            document.strucData[time]['project']['PCH']    += duration;
                            rowObj['project'] = 'PCH';
                        }
                        else if (document.proj.door3.some(function(v) { return (app+title).toLowerCase().indexOf(v) >= 0; }))  {
                            document.strucData[time]['project']['DOOR3']    += duration;
                            rowObj['project'] = 'DOOR3';
                        } else {
                            document.strucData[time]['project']['UNALOCATED'] += duration;
                        }
                    });
                    document.jsonQobj=jsonQ(document.strucData);
                    document.WAHV = document.jsonQobj.find('document',function () {
                        return this[3].toLowerCase().indexOf('wahv') !== -1;
                        //return this[0].toLowerCase().includes('wahv');
                    });

                });
            } );

        });

    </script>
</head>
<body>

<label>Pick a day to load: </label><div id="datepicker"></div>
<br><button id="load-data" class="ui-button ui-widget ui-corner-all">load data</button>
<div><h1>Projects</h1>
<h2>WAHV</h2>
<label>Keywords</label>
<textarea title="keywords-wahv" id="keywords-wahv" rows="10" cols="50">
wahv
webdriver
knex
</textarea>
    <label>Probably Keywords</label>
<textarea title="probablykeywords-wahv" id="probablykeywords-wahv" rows="10" cols="50">
chimp
webdriver
knex
</textarea>
    <br>
<h2>Greenhill</h2>
<label>Keywords</label>
<textarea title="keywords-green" id="keywords-green" rows="10" cols="50">
green
dunn
808705e3-d1e0-48d6-9e92-563ba1af548e
gs-
amCharts
</textarea>
    <label>Probably Keywords</label>
<textarea title="probablykeywords-wahv" id="probablykeywords-wahv" rows="10" cols="50">

</textarea>
</div>

<br>
<textarea title="debug dump" id="preview-json"  rows="100" cols="80"></textarea>
</body>
</html>
